---
# - name: Update system packages block
#   block:
#     - name: Update system packages
#       package:
#         name: "*"
#         state: latest
#   # Update may fail try to repair with disable and enable of repos.      
#   rescue:
#     - name: disable repos
#       command: "subscription-manager repos --disable {{ item }}"
#       with_items:
#       - rhel-8-for-x86_64-appstream-rpms
#       - rhel-8-for-x86_64-baseos-rpms
  
#     - name: enable repos
#       command: "subscription-manager repos --enable {{ item }}"  
#       with_items:
#       - rhel-8-for-x86_64-appstream-rpms
#       - rhel-8-for-x86_64-baseos-rpms

#     - name: Update system packages
#       package:
#         name: "*"
#         state: latest

- name: Install some packages needed to configure the nodes
  ansible.builtin.package:
    name: "{{ item }}"
  with_items:
    - "{{ basic_packages }}"    

- name: Copy Root Certificates into the anchors folder  
  copy:
    src: "rootca/"
    dest: "/etc/pki/ca-trust/source/anchors/"
  register: result
  
- name: Update CA Trusts
  command: update-ca-trust
  when: result is changed

- name: Add Pip config so we point to our repository
  ansible.builtin.template:
    src: pip.conf.j2
    dest: '/etc/pip.conf'

- name: Install kubenetes python package
  ansible.builtin.pip:
    name: kubernetes        
    state: present
    executable: pip3
       